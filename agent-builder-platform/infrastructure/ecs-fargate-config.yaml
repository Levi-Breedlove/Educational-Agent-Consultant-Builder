# ECS Fargate Configuration for Agent Builder Platform
# This configuration defines the containerized deployment setup

apiVersion: v1
kind: ECSConfiguration
metadata:
  name: agent-builder-platform
  environment: dev

# ECS Cluster Configuration
cluster:
  name: agent-builder-cluster
  capacity_providers:
    - FARGATE
    - FARGATE_SPOT
  default_capacity_provider_strategy:
    - capacity_provider: FARGATE
      weight: 1
      base: 1

# Task Definition for Agent Core Service
task_definition:
  family: agent-core-service
  network_mode: awsvpc
  requires_compatibilities:
    - FARGATE
  cpu: "256"  # 0.25 vCPU
  memory: "512"  # 512 MB
  
  execution_role_arn: "arn:aws:iam::ACCOUNT:role/ecsTaskExecutionRole"
  task_role_arn: "arn:aws:iam::ACCOUNT:role/agentCoreTaskRole"
  
  container_definitions:
    - name: agent-core-container
      image: "agent-builder-platform:latest"
      essential: true
      
      port_mappings:
        - container_port: 8000
          protocol: tcp
      
      environment:
        - name: ENVIRONMENT
          value: "dev"
        - name: PROJECT_NAME
          value: "agent-builder-platform"
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
        - name: LOG_LEVEL
          value: "INFO"
      
      log_configuration:
        log_driver: awslogs
        options:
          awslogs-group: "/ecs/agent-core-service"
          awslogs-region: "us-east-1"
          awslogs-stream-prefix: "ecs"
      
      health_check:
        command:
          - "CMD-SHELL"
          - "curl -f http://localhost:8000/health || exit 1"
        interval: 30
        timeout: 5
        retries: 3
        start_period: 60

# ECS Service Configuration
service:
  name: agent-core-service
  cluster: agent-builder-cluster
  task_definition: agent-core-service
  desired_count: 1
  
  launch_type: FARGATE
  platform_version: "LATEST"
  
  network_configuration:
    awsvpc_configuration:
      subnets:
        - "subnet-12345678"  # Private subnet
        - "subnet-87654321"  # Private subnet
      security_groups:
        - "sg-agent-core"
      assign_public_ip: DISABLED
  
  load_balancers:
    - target_group_arn: "arn:aws:elasticloadbalancing:us-east-1:ACCOUNT:targetgroup/agent-core-tg/1234567890123456"
      container_name: agent-core-container
      container_port: 8000
  
  service_registries:
    - registry_arn: "arn:aws:servicediscovery:us-east-1:ACCOUNT:service/srv-agent-core"
      container_name: agent-core-container
      container_port: 8000

# Auto Scaling Configuration
auto_scaling:
  min_capacity: 1
  max_capacity: 10
  target_tracking_scaling_policies:
    - target_value: 70.0
      scale_in_cooldown: 300
      scale_out_cooldown: 300
      metric_type: ECSServiceAverageCPUUtilization
    
    - target_value: 80.0
      scale_in_cooldown: 300
      scale_out_cooldown: 300
      metric_type: ECSServiceAverageMemoryUtilization

# IAM Roles and Policies
iam:
  execution_role:
    name: ecsTaskExecutionRole
    policies:
      - "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
      - custom_policy:
          name: AgentCoreExecutionPolicy
          statements:
            - effect: Allow
              actions:
                - "logs:CreateLogGroup"
                - "logs:CreateLogStream"
                - "logs:PutLogEvents"
              resources:
                - "arn:aws:logs:*:*:*"
  
  task_role:
    name: agentCoreTaskRole
    policies:
      - custom_policy:
          name: AgentCoreTaskPolicy
          statements:
            - effect: Allow
              actions:
                - "s3:GetObject"
                - "s3:PutObject"
                - "s3:DeleteObject"
                - "s3:ListBucket"
              resources:
                - "arn:aws:s3:::agent-builder-projects/*"
                - "arn:aws:s3:::agent-builder-generated-agents/*"
            
            - effect: Allow
              actions:
                - "dynamodb:GetItem"
                - "dynamodb:PutItem"
                - "dynamodb:UpdateItem"
                - "dynamodb:DeleteItem"
                - "dynamodb:Query"
                - "dynamodb:Scan"
              resources:
                - "arn:aws:dynamodb:us-east-1:*:table/agent-configurations"
                - "arn:aws:dynamodb:us-east-1:*:table/project-metadata"
            
            - effect: Allow
              actions:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              resources:
                - "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1"

# Security Groups
security_groups:
  - name: sg-agent-core
    description: Security group for Agent Core service
    ingress_rules:
      - protocol: tcp
        from_port: 8000
        to_port: 8000
        source_security_group: sg-alb
        description: "Allow traffic from ALB"
    
    egress_rules:
      - protocol: -1
        from_port: -1
        to_port: -1
        cidr_blocks: ["0.0.0.0/0"]
        description: "Allow all outbound traffic"

# Application Load Balancer
load_balancer:
  name: agent-core-alb
  scheme: internal
  type: application
  
  subnets:
    - "subnet-12345678"
    - "subnet-87654321"
  
  security_groups:
    - "sg-alb"
  
  target_groups:
    - name: agent-core-tg
      protocol: HTTP
      port: 8000
      vpc_id: "vpc-12345678"
      
      health_check:
        enabled: true
        healthy_threshold_count: 2
        interval_seconds: 30
        matcher: "200"
        path: "/health"
        port: "traffic-port"
        protocol: HTTP
        timeout_seconds: 5
        unhealthy_threshold_count: 2
  
  listeners:
    - port: 80
      protocol: HTTP
      default_actions:
        - type: forward
          target_group_arn: "arn:aws:elasticloadbalancing:us-east-1:ACCOUNT:targetgroup/agent-core-tg/1234567890123456"

# CloudWatch Log Groups
log_groups:
  - name: "/ecs/agent-core-service"
    retention_in_days: 30
    
# Service Discovery
service_discovery:
  namespace:
    name: agent-builder.local
    type: DNS_PRIVATE
    vpc_id: "vpc-12345678"
  
  service:
    name: agent-core
    dns_config:
      namespace_id: "ns-12345678"
      dns_records:
        - type: A
          ttl: 60